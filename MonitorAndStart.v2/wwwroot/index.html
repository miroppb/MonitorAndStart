<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Monitor & Start — Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 1rem;
            padding-bottom: 4rem;
        }

        /* Masonry-style container */
        .masonry {
            column-gap: 1rem;
        }

        .masonry-item {
            display: inline-block;
            width: 100%;
            margin: 0 0 1rem;
            break-inside: avoid;
        }

        /* responsive column counts */
        @media (max-width: 575.98px) {
            .masonry {
                column-count: 1;
            }
        }

        @media (min-width: 576px) and (max-width: 991.98px) {
            .masonry {
                column-count: 2;
            }
        }

        @media (min-width: 992px) {
            .masonry {
                column-count: 3;
            }
        }

        .job-row {
            padding: .45rem .75rem;
            border-radius: .375rem;
        }

        .logs-box {
            height: 260px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow: auto;
            background: #111;
            color: #ddd;
            padding: .75rem;
            border-radius: .5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex align-items-center mb-3">
            <h3 class="me-auto">Monitor & Start — Web Control</h3>
            <button id="refreshBtn" class="btn btn-sm btn-outline-secondary">Refresh</button>
        </div>

        <!-- masonry container -->
        <div id="workflows" class="masonry"></div>

        <hr class="my-4">

        <div class="mb-2 d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Logs (optional)</h5>
            <div>
                <button id="loadLogsBtn" class="btn btn-sm btn-outline-primary">Load logs</button>
                <button id="clearLogsBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
            </div>
        </div>
        <div id="logs" class="logs-box">Logs not loaded. Click "Load logs".</div>
    </div>

    <!-- Toast container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1055;">
        <div id="toastContainer"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>const api = {
    workflows: '/api/workflows',
    runWorkflow: id => `/api/workflows/${id}/run`,
    runJob: id => `/api/jobs/${id}/run`,
    logs: '/api/logs'
  };

  function getProp(obj, ...names) {
    for (const n of names) {
      if (obj && Object.prototype.hasOwnProperty.call(obj, n)) return obj[n];
    }
    return undefined;
  }

  async function showToast(message, type = 'primary', autohide = true) {
    const id = 't' + Date.now();
    const toastHtml = `
      <div id="${id}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`;
    $('#toastContainer').append(toastHtml);
    const el = document.getElementById(id);
    const t = new bootstrap.Toast(el, { autohide, delay: 3000 });
    t.show();
    el.addEventListener('hidden.bs.toast', () => el.remove());
  }

  async function fetchWorkflows() {
    try {
      const res = await fetch(api.workflows, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      renderWorkflows(data);
    } catch (err) {
      $('#workflows').html(`<div class="alert alert-danger">Failed to load workflows: ${err.message}</div>`);
    }
  }

  function renderWorkflows(data) {
    if (!Array.isArray(data) || data.length === 0) {
      $('#workflows').html('<div class="alert alert-warning">No workflows found.</div>');
      return;
    }

    const cards = data.map(w => {
      const wid = getProp(w, 'id', 'Id');
      const wName = getProp(w, 'name', 'Name') || '(unnamed)';
      const wEnabled = !!getProp(w, 'enabled', 'Enabled');

      const jobs = Array.isArray(getProp(w, 'jobs', 'Jobs')) ? getProp(w, 'jobs', 'Jobs') : [];
      const jobsHtml = jobs.map(j => {
        const jid = getProp(j, 'id', 'Id');
        const jName = getProp(j, 'name', 'Name') || '(unnamed)';
        const jEnabled = !!getProp(j, 'enabled', 'Enabled');
        const disabledAttr = jEnabled ? '' : 'disabled';
        const disabledBadge = jEnabled ? '' : '<span class="badge bg-secondary ms-2">disabled</span>';
        return `<div class="d-flex job-row bg-light mb-2">
                  <div class="flex-grow-1">
                    <strong>${escapeHtml(jName)}</strong>
                    <div class="text-muted small">ID: ${escapeHtml(jid)} ${disabledBadge}</div>
                  </div>
                  <div>
                    <button class="btn btn-sm btn-success me-1" ${disabledAttr} data-jobrun="${escapeHtml(jid)}">Run</button>
                  </div>
                </div>`;
      }).join('');

      const wfDisabledAttr = wEnabled ? '' : 'disabled';
      const wfDisabledBadge = wEnabled ? '' : '<span class="badge bg-secondary ms-2">disabled</span>';

      // wrap each card as a masonry-item so they tile without vertical gaps
      return `<div class="masonry-item">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex mb-2">
              <div class="me-auto">
                <h5 class="card-title mb-0">${escapeHtml(wName)}</h5>
                <div class="text-muted small">ID: ${escapeHtml(wid)} ${wfDisabledBadge}</div>
              </div>
              <div>
                <button class="btn btn-sm btn-primary" ${wfDisabledAttr} data-workrun="${escapeHtml(wid)}">Run Workflow</button>
              </div>
            </div>
            <div>${jobsHtml}</div>
          </div>
        </div>
      </div>`;
    }).join('');

    $('#workflows').html(cards);
  }

  function escapeHtml(s) {
    if (s === null || s === undefined) return '';
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
  }

  async function postRun(url, successMsg, buttonEl) {
    try {
      if (buttonEl) buttonEl.prop('disabled', true);
      const res = await fetch(url, { method: 'POST' });
      if (res.ok) {
        showToast(successMsg, 'success');
      } else {
        const text = await res.text().catch(()=>res.statusText);
        showToast(`Failed: ${res.status} ${text}`, 'danger');
      }
    } catch (err) {
      showToast(`Error: ${err.message}`, 'danger');
    } finally {
      if (buttonEl) buttonEl.prop('disabled', false);
    }
  }

  $(document).on('click', '[data-workrun]', function() {
    const $btn = $(this);
    const id = $btn.attr('data-workrun');
    if (!id) return;
    if (!confirm('Run workflow ' + id + '?')) return;
    postRun(api.runWorkflow(id), 'Workflow run requested', $btn);
  });

  $(document).on('click', '[data-jobrun]', function() {
    const $btn = $(this);
    const id = $btn.attr('data-jobrun');
    if (!id) return;
    if (!confirm('Run job ' + id + '?')) return;
    postRun(api.runJob(id), 'Job run requested', $btn);
  });

  $('#refreshBtn').on('click', fetchWorkflows);

  $('#loadLogsBtn').on('click', async () => {
    try {
      const res = await fetch(api.logs);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const txt = await res.text();
      $('#logs').text(txt || '(no logs)');
    } catch (err) {
      $('#logs').text('Unable to retrieve logs: ' + err.message);
    }
  });

  $('#clearLogsBtn').on('click', () => $('#logs').text(''));

  fetchWorkflows();
  setInterval(fetchWorkflows, 10000);</script>
</body>
</html>